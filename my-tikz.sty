%% personal config for TikZ
%% C. Garion, 2012
%%
\NeedsTeXFormat{LaTeX2e}[1995/12/01]
\ProvidesPackage{my-tikz}[2012/08/15 v0.1 
                 LaTeX package for TikZ configuration]

% packages and TikZ librairies
\RequirePackage{tikz}
\usetikzlibrary{shapes}
\usetikzlibrary{positioning}
\usetikzlibrary{fit}
\usetikzlibrary{backgrounds}
\pgfdeclarelayer{background}
\pgfsetlayers{background,main}
\usetikzlibrary{chains}
\usetikzlibrary{scopes}
\usetikzlibrary{shadows}

% commands and defs
\newcommand{\tikzer}[0]{
  \usetikzlibrary{er}
  \tikzstyle{every entity}=[draw=green!50,fill=green!20,thick]
  \tikzstyle{every relationship}=[draw=blue!50,fill=blue!20,thick,aspect=2]
  \tikzstyle{every attribute}=[draw=violet!50,fill=violet!20,thick]
  \tikzstyle{weakentity}=[entity, double distance=2pt]
  \tikzstyle{weakrelationship}=[relationship, double distance=2pt]
}

\newcommand*\keystroke[1]{%
  \tikz[baseline=(key.base)]
    \node[%
      draw,
      fill=white,
      drop shadow={shadow xshift=0.25ex,shadow yshift=-0.25ex,fill=black,opacity=0.75},
      rectangle,
      rounded corners=2pt,
      inner sep=1pt,
      line width=0.5pt,
      font=\scriptsize\sffamily
    ](key) {#1\strut}
  ;
}

% environements
\newenvironment{umltikzpicture}[1][]{%
\begin{microtypecontext}{kerning=uml}%
\begin{tikzpicture}[#1]%
}{%
\end{tikzpicture}%
\end{microtypecontext}%
}%

% Slightly modified from
% http://tex.stackexchange.com/questions/17898/how-can-i-produce-a-ring-or-wheel-chart-like-that-on-page-88-of-the-pgf-manua
% New command for a wheel chart
% Thanks!
%
% Usage in a tikzpicture env.:
% \wheelchart{center name}{options for center node}{number/color/label,...}
%
% Options:
%  - \inneradius
%  - \outeradius
%  - \my-unit
%  - /wc name if label name wanted
%  - /wc value if label value wanted
%  - /wc perc if label percentage wanted

\def\innerradius{1.8cm}
\def\outerradius{2.2cm}

\def\my-unit{}

\newif\ifname
\pgfkeys{/wc name/.is if=name}
\pgfkeys{/wc name=true}
\newif\ifvalue
\pgfkeys{/wc value/.is if=value}
\newif\ifpercentage
\pgfkeys{/wc perc/.is if=percentage}

% The main macro
\newcommand{\wheelchart}[3]{
    % Calculate total
    \pgfmathsetmacro{\totalnum}{0}
    \foreach \value/\colour/\name in {#3} {
        \pgfmathparse{\value+\totalnum}
        \global\let\totalnum=\pgfmathresult
    }

    % The text in the center of the wheel
      \node[align=center,text width=2*\innerradius,#2] (wheel-center) {#1};

      % Calculate the thickness and the middle line of the wheel
      \pgfmathsetmacro{\wheelwidth}{\outerradius-\innerradius}
      \pgfmathsetmacro{\midradius}{(\outerradius+\innerradius)/2}

      % Rotate so we start from the top
      \begin{scope}[line width=\wheelwidth,rotate=90]

      % Loop through each value set. \cumnum keeps track of where we are in the wheel
      \pgfmathsetmacro{\cumnum}{0}
      \foreach \value/\colour/\name in {#3} {
            \pgfmathsetmacro{\newcumnum}{\cumnum + \value/\totalnum*360}

            % Calculate the percent value
            \pgfmathsetmacro{\percentage}{\value/\totalnum*100}
            % Calculate the mid angle of the colour segments to place the labels
            \pgfmathsetmacro{\midangle}{-(\cumnum+\newcumnum)/2}

            % This is necessary for the labels to align nicely
            \pgfmathparse{
               (-\midangle<5?"south":
                (-\midangle<85?"south west":
                 (-\midangle<105?"west":
                  (-\midangle<175?"north west":
                   (-\midangle<185?"north":
                    (-\midangle<265?"north east":
                     (-\midangle<275?"east":
                      (-\midangle<355?"south east":"south")
                     )
                    )
                   )
                  )
                 )
                )
               )
            } \edef\textanchor{\pgfmathresult}

            % Draw the color segments. Somehow, the \midrow units got lost, so we add 'pt' at the end. Not nice...
            \draw[\colour] (-\cumnum:\midradius pt) arc (-\cumnum:-(\newcumnum):\midradius pt);

            % Draw the data labels
            \node at (\midangle:\outerradius + 1ex) [inner sep=0pt,
            outer sep=0pt,
            anchor=\textanchor]{\ifname\name\fi\ifvalue\ifname:
              \fi\fi\ifvalue\value\my-unit\fi\ifpercentage\ifname\
              (\fi\pgfmathprintnumber{\percentage}\%\ifname )\fi\fi};

            % Set the old cumulated angle to the new value
            \global\let\cumnum=\newcumnum
        }

      \end{scope}

      \foreach \i in {0,8,...,352} {
        \draw [gray,thin] (\i:\innerradius) -- (\i:\outerradius);
      }
      \draw[gray] (0,0) circle (\outerradius) circle (\innerradius);
}

% for beamer overlays
\tikzset{onslide/.code args={<#1>#2}{%
  \only<#1>{\pgfkeysalso{#2}} 
}}
